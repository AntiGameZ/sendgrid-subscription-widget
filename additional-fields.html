<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>SendGrid Subscription Widget - Additional Field Setup</title>
    
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <img src="images/sendgrid-logo.png" alt="SendGrid">
        <h1>Subscription Widget</h1>
        <p class="view"><a href="http://github.com/sendgrid/sendgrid-subscription-widget">View the Project on GitHub <small>sendgrid/sendgrid-subscription-widget</small></a></p>
      </header>
      <section>
        <h1>Additional Fields</h1>
        <p>The SendGrid Subscription Service assigns alphabetical keys to each variable to be stored in addition to the email.</p>

        <p>To get the keys into your form, insert your subscription widget token below, and hit enter.</p>

        <hr>

        <div id="setup">
          <form id="token-form">
            <label for="token">Token</label>
            <input type="text" id="token">
          </form>
          
          <pre id="code" class="hide code-block"><code></code></pre>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/jquery-1.10.1.min.js"><\/script>')</script>

        <script>
          previousToken = "";
          $(function () {
            $("#token-form").submit(function (e) {
              e.preventDefault();

              var token = $("#token").val();

              if(token == previousToken) {
                return;
              }
              
              var oldWidget = '<script id="old-script" type="text/javascript" src="http://sendgrid.com/newsletter/getSubscriptionWidget?p=' + token + '"><\/script>';

              $("#old").remove();
              $old = $('<div id="old"></div>').hide().html(oldWidget);
              $old.appendTo("body");
              $form = $("<div></div>");
              var interval = setInterval(function () {
                if($old.find("script").length == 0){
                  $old.find("label").each(function () {
                    var $labelFor = $("#" + $(this).attr("for") );
                    var inputName = $labelFor.attr("name").replace(/^SG_widget\[(.+?)\]$/, "$1");
                    if($labelFor.attr("name") !== "SG_widget[email]"){
                      var $formObj = $('<label><span></span><input type="text"></label>');
                      $formObj.find("span").html( $(this).html() );
                      $formObj.find("input").attr("name", inputName);
                      $form.append($formObj);
                    }
                  });

                  var customFields = $form.html();
                  var widget = "<div class=\"sendgrid-subscription-widget\" data-token=\"" + token + "\">" + customFields + "</div>\n<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://s3.amazonaws.com/subscription-cdn/0.2/widget.min.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'sendgrid-subscription-widget-js');<\/script>";
                  
                  $("#code code").text(widget).parent().slideDown("fast", function () {
                    var range = document.createRange();
                    range.selectNodeContents(this);
                    var select = window.getSelection();
                    select.removeAllRanges();
                    select.addRange(range);
                  });

                  clearInterval(interval);
                }
              }, 100);
            });
          });
        </script>
      </section>
      <footer>
        <p>This project is maintained by <a href="http://sendgrid.com/developers">SendGrid</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
  </body>
</html>
